<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corethink app</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src='https://unpkg.com/react@17/umd/react.production.min.js'></script>
  <script src='https://unpkg.com/react-dom@17/umd/react-dom.production.min.js'></script>
  <script src='https://unpkg.com/react-router-dom@5.0.0/umd/react-router-dom.min.js'></script>
  <script src='https://unpkg.com/babel-standalone@6.26.0/babel.js'></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div id='root'></div>
  <script type='text/babel'>
    const firebaseConfig = {
      apiKey: "AIzaSyDXazKYgxuKw5U222WW7y9Tqb2vGw-ZiJE",
      authDomain: "corethink-test.firebaseapp.com",
      projectId: "corethink-test",
      storageBucket: "corethink-test.firebasestorage.app",
      messagingSenderId: "556802107225",
      appId: "1:556802107225:web:fb9b5f7b8feb3af7d1ce48"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();


    class TodoService {
      static collection = db.collection('todos');

      // CREATE - Add new todo
      static async create(text) {
        try {
          const docRef = await this.collection.add({
            text: text.trim(),
            completed: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          return { success: true, id: docRef.id };
        } catch (error) {
          console.error('Error creating todo:', error);
          return { success: false, error: error.message };
        }
      }

      // READ - Get all todos with real-time updates
      static subscribe(callback) {
        const unsubscribe = this.collection
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            const todos = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            callback(todos);
          }, (error) => {
            console.error('Error fetching todos:', error);
            callback([]);
          });
        return unsubscribe;
      }

      // UPDATE - Edit todo
      static async update(id, updates) {
        try {
          await this.collection.doc(id).update({
            ...updates,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          return { success: true };
        } catch (error) {
          console.error('Error updating todo:', error);
          return { success: false, error: error.message };
        }
      }

      // DELETE - Remove todo
      static async delete(id) {
        try {
          await this.collection.doc(id).delete();
          return { success: true };
        } catch (error) {
          console.error('Error deleting todo:', error);
          return { success: false, error: error.message };
        }
      }

      // BULK DELETE - Remove multiple todos
      static async deleteMultiple(ids) {
        try {
          const batch = db.batch();
          ids.forEach(id => {
            batch.delete(this.collection.doc(id));
          });
          await batch.commit();
          return { success: true };
        } catch (error) {
          console.error('Error deleting multiple todos:', error);
          return { success: false, error: error.message };
        }
      }

      // TOGGLE COMPLETE - Shortcut for updating completion status
      static async toggleComplete(id, currentStatus) {
        return this.update(id, { completed: !currentStatus });
      }

      // UPDATE TEXT - Shortcut for updating text
      static async updateText(id, newText) {
        return this.update(id, { text: newText.trim() });
      }
    }


    const TodoApp = () => {
      const [todos, setTodos] = React.useState([]);
      const [newTodo, setNewTodo] = React.useState('');
      const [editingId, setEditingId] = React.useState(null);
      const [editText, setEditText] = React.useState('');
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        const unsubscribe = TodoService.subscribe((todos) => {
          setTodos(todos);
          setLoading(false);
        });

        return unsubscribe;
      }, []);

      const handleAddTodo = async (e) => {
        e.preventDefault();
        if (!newTodo.trim()) return;

        const result = await TodoService.create(newTodo);
        if (result.success) {
          setNewTodo('');
        } else {
          alert('Failed to add todo: ' + result.error);
        }
      };

      const handleUpdateTodo = async (id, newText) => {
        const result = await TodoService.updateText(id, newText);
        if (!result.success) {
          alert('Failed to update todo: ' + result.error);
        }
      };

      const handleDeleteTodo = async (id) => {
        if (confirm('Are you sure you want to delete this todo?')) {
          const result = await TodoService.delete(id);
          if (!result.success) {
            alert('Failed to delete todo: ' + result.error);
          }
        }
      };

      const handleToggleComplete = async (id, currentStatus) => {
        const result = await TodoService.toggleComplete(id, currentStatus);
        if (!result.success) {
          alert('Failed to update todo: ' + result.error);
        }
      };

      const handleClearCompleted = async () => {
        const completedIds = todos
          .filter(todo => todo.completed)
          .map(todo => todo.id);

        if (completedIds.length === 0) return;

        if (confirm(`Delete ${completedIds.length} completed todos?`)) {
          const result = await TodoService.deleteMultiple(completedIds);
          if (!result.success) {
            alert('Failed to clear completed todos: ' + result.error);
          }
        }
      };

      const startEdit = (id, text) => {
        setEditingId(id);
        setEditText(text);
      };

      const saveEdit = async () => {
        if (editText.trim()) {
          await handleUpdateTodo(editingId, editText);
        }
        setEditingId(null);
        setEditText('');
      };

      const cancelEdit = () => {
        setEditingId(null);
        setEditText('');
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="loading loading-spinner loading-lg"></div>
          </div>
        );
      }

      const totalTodos = todos.length;
      const completedTodos = todos.filter(todo => todo.completed);
      const activeTodos = todos.filter(todo => !todo.completed);

      return (
        <div className="min-h-screen bg-base-200 p-4">
          <div className="max-w-2xl mx-auto">
            <h1 className="text-4xl font-bold text-center mb-8">üìù Simple Todo App</h1>

            <form onSubmit={handleAddTodo} className="mb-8">
              <div className="join w-full">
                <input
                  type="text"
                  placeholder="Enter your todo..."
                  className="input input-bordered join-item flex-1"
                  value={newTodo}
                  onChange={(e) => setNewTodo(e.target.value)}
                />
                <button type="submit" className="btn btn-primary join-item">
                  Add Todo
                </button>
              </div>
            </form>

            {totalTodos > 0 && (
              <div className="flex justify-between items-center mb-6">
                <span className="text-sm text-gray-600">
                  {activeTodos.length} active, {completedTodos.length} completed
                </span>
                {completedTodos.length > 0 && (
                  <button
                    onClick={handleClearCompleted}
                    className="btn btn-sm btn-outline btn-error"
                  >
                    Clear Completed ({completedTodos.length})
                  </button>
                )}
              </div>
            )}

            <div className="space-y-4">
              {todos.length === 0 ? (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">üìù</div>
                  <p className="text-gray-500">No todos yet. Add one above!</p>
                </div>
              ) : (
                todos.map((todo) => (
                  <div key={todo.id} className="card bg-base-100 shadow-md">
                    <div className="card-body py-4">
                      <div className="flex items-center gap-4">
                        <input
                          type="checkbox"
                          className="checkbox checkbox-primary"
                          checked={todo.completed}
                          onChange={() => handleToggleComplete(todo.id, todo.completed)}
                        />

                        <div className="flex-1">
                          {editingId === todo.id ? (
                            <div className="flex gap-2">
                              <input
                                type="text"
                                className="input input-sm input-bordered flex-1"
                                value={editText}
                                onChange={(e) => setEditText(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && saveEdit()}
                                autoFocus
                              />
                              <button onClick={saveEdit} className="btn btn-sm btn-success">
                                Save
                              </button>
                              <button onClick={cancelEdit} className="btn btn-sm btn-ghost">
                                Cancel
                              </button>
                            </div>
                          ) : (
                            <div className="flex items-center justify-between">
                              <span className={todo.completed ? 'line-through opacity-50' : ''}>
                                {todo.text}
                              </span>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => startEdit(todo.id, todo.text)}
                                  className="btn btn-sm btn-ghost"
                                  disabled={todo.completed}
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => handleDeleteTodo(todo.id)}
                                  className="btn btn-sm btn-ghost text-red-500 hover:bg-red-50"
                                >
                                  Delete
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>

            {totalTodos > 0 && (
              <div className="stats shadow w-full mt-8">
                <div className="stat">
                  <div className="stat-title">Total Todos</div>
                  <div className="stat-value">{totalTodos}</div>
                </div>
                <div className="stat">
                  <div className="stat-title">Active</div>
                  <div className="stat-value text-warning">{activeTodos.length}</div>
                </div>
                <div className="stat">
                  <div className="stat-title">Completed</div>
                  <div className="stat-value text-success">{completedTodos.length}</div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };


    const { Link, Route, MemoryRouter } = ReactRouterDOM;

    const App = () => {
      return (
        <MemoryRouter initialEntries={["/"]} initialIndex={0}>
          <Route path="/" exact component={TodoApp} />
        </MemoryRouter>
      );
    };

    ReactDOM.render(<App />, document.querySelector('#root'));

  </script>
</body>

</html>